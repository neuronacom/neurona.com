<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Neurona 1.0</title>
  <style>
    /* Сброс */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #fff; color: #000; font-family: sans-serif;
      height: 100vh; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    #loader {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 1001;
    }
    .loader-text {
      font-size: 3rem; letter-spacing: .2em;
      color: #000; animation: fade 3s ease-in-out infinite;
    }
    @keyframes fade { 0%,100%{opacity:0;}50%{opacity:1;} }
    #app {
      position: relative; display: flex; flex-direction: column;
      width: 100%; max-width: 600px; height: 100%;
      padding: 20px 10px 10px; z-index: 1; opacity: 0;
      transition: opacity 1s ease;
    }
    body.loaded #app { opacity: 1; }
    .chat-container {
      flex: 1; background: rgba(255,255,255,0.9);
      border-radius: 8px; border:1px solid #ccc;
      box-shadow:0 4px 10px rgba(0,0,0,0.1);
      display:flex; flex-direction:column; overflow:hidden;
    }
    #messages {
      flex:1; padding:15px; overflow-y:auto;
      display:flex; flex-direction:column;
    }
    .message {
      margin:5px 0; padding:8px 12px; line-height:1.4;
      max-width:80%; border-radius:12px; word-wrap:break-word;
    }
    .message.user { align-self:flex-end; background:#f0f0f0; }
    .message.bot  { align-self:flex-start; background:#e0e0e0; }
    .message.typing { font-style:italic; color:#666; }
    .input-area {
      display:flex; padding:10px; background:#fff;
    }
    #input {
      flex:1; resize:none; height:50px;
      padding:12px; border:1px solid #ccc; border-radius:4px;
      font-size:1rem;
    }
    #send {
      margin-left:8px; padding:0 16px;
      border:none; border-radius:4px;
      background:#444; color:#fff;
      font-size:1rem; cursor:pointer;
      transition:background .2s;
    }
    #send:hover { background:#666; }
    @media(max-width:600px){
      #app{max-width:100%;padding:15px 5px 5px}
      #input{height:40px;font-size:.9rem}
      #send{padding:0 12px;font-size:.9rem}
    }
  </style>
</head>
<body>
  <div id="loader"><div class="loader-text">NEURONA 1.0</div></div>
  <div id="app">
    <div class="chat-container">
      <div id="messages"></div>
      <div class="input-area">
        <textarea id="input" placeholder="Напишите сообщение..."></textarea>
        <button id="send">Отправить</button>
      </div>
    </div>
  </div>

  <script>
    // Прелоадер
    window.addEventListener('load', ()=>{
      setTimeout(()=>{
        document.getElementById('loader').style.display='none';
        document.body.classList.add('loaded');
        loadHistory();
      }, 1500);
    });

    // История
    let messages=[];
    function saveHistory(){ localStorage.setItem('neurona_history',JSON.stringify(messages)); }
    function loadHistory(){
      const h=JSON.parse(localStorage.getItem('neurona_history')||'[]');
      if(h.length){ messages=h; h.forEach(m=>addMessage(m.content,m.role)); }
    }

    // Отображение
    const msgs=document.getElementById('messages');
    function addMessage(txt,who){
      const d=document.createElement('div');
      d.className='message '+who; d.textContent=txt;
      msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight;
    }
    function addTyping(){
      const d=document.createElement('div');
      d.className='message bot typing'; d.textContent='...';
      msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight;
      return d;
    }

    // Системное
    function getSystem(){
      const d=new Date().toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
      return {role:'system',content:`Ты — Neurona 1.0.\nСегодня ${d}.\nОтвечай развёрнуто.`};
    }

    // Hugging Face API
    const HF_API_TOKEN = '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';
    const HF_API_URL   = 'https://api-inference.huggingface.co/models/tiiuae/falcon-40b-instruct';

    // Отправка
    document.getElementById('send').onclick=async()=>{
      const input=document.getElementById('input'), txt=input.value.trim();
      if(!txt) return;
      if(messages.length===0) messages.push(getSystem());
      messages.push({role:'user',content:txt});
      addMessage(txt,'user'); input.value='';
      const typ=addTyping();

      // Формируем prompt
      let prompt='';
      messages.forEach(m=>{
        if(m.role==='system')    prompt+=`<|SYS|>${m.content}\n`;
        else if(m.role==='user') prompt+=`<|USR|>${m.content}\n`;
        else                     prompt+=`<|ASS|>${m.content}\n`;
      });
      prompt+='<|ASS|>';

      try{
        const res=await fetch(HF_API_URL,{
          method:'POST',
          headers:{
            'Authorization':`Bearer ${HF_API_TOKEN}`,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({inputs: prompt, options:{use_cache:false}})
        });
        const j=await res.json();
        const reply = (j.generated_text || j[0]?.generated_text || '').trim() || 'Ошибка ответа';
        typ.remove(); addMessage(reply,'bot');
        messages.push({role:'assistant',content:reply}); saveHistory();
      }catch(e){
        typ.remove(); addMessage('Ошибка связи.', 'bot'); console.error(e);
      }
    };
  </script>
</body>
</html>

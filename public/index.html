<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Neurona 1.0</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body, textarea, button { font-family:Arial,sans-serif; }
    body { background:#fff; color:#000; overflow:hidden; height:100vh; }
    #bg { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:0; opacity:0.8; transition:opacity 1s ease; pointer-events:none; }
    body.loaded #bg { opacity:0.2; }
    
    /* --- TOP BAR --- */
    .top-bar {
      width:100vw;
      position:fixed;
      top:0; left:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:transparent;
      height:62px;
      pointer-events: none;
      transition: opacity .3s;
    }
    .top-bar-content {
      display:flex;
      align-items:center;
      height:62px;
      pointer-events: all;
    }
    .top-logo { width:39px; height:auto; margin-left:18px; margin-right:12px; }
    .top-title {
      font-size:2.2rem;
      letter-spacing:.13em;
      font-weight:bold;
      color:#000;
      user-select:none;
      text-transform:uppercase;
      margin-top:2px;
      letter-spacing:.15em;
    }
    .top-burger {
      display:flex; flex-direction:column; justify-content:center;
      width:48px; height:48px; margin-right:25px; cursor:pointer; pointer-events:all;
      align-items: flex-end;
    }
    .top-burger span {
      display:block;
      height:8px; width:100%; background:#000; border-radius:4px; margin-bottom:7px;
    }
    .top-burger span:last-child { margin-bottom:0; }

    .top-bar.hide { opacity:0; pointer-events:none; }

    #loader {
      position:fixed; inset:0;
      background:rgba(255,255,255,0.98);
      display:flex; align-items:center; justify-content:center;
      z-index:1001; flex-direction:column;
      min-height:100vh;
    }
    .loader-content {
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      animation:fade 8s ease-in-out infinite;
      z-index:1002;
      pointer-events: none;
    }
    .loader-logo { width:120px; margin-bottom:10px; }
    .loader-title {
      font-size:5.7rem;
      font-weight:bold;
      letter-spacing:.16em;
      color:#000;
      text-shadow: 0 1px 0 #fff, 0 4px 16px #bbb6;
      margin-bottom:6px;
      line-height:1.0;
      text-align:center;
    }
    .loader-subtitle {
      font-size:1.3rem;
      letter-spacing:.05em;
      color:#000;
      margin-top:0px;
      line-height:1.05;
      text-align:center;
      font-weight:400;
    }
    @keyframes fade { 0%,100%{opacity:0;} 50%{opacity:1;} }

    #app {
      position: absolute;
      left:50%; top:53%;
      transform:translate(-50%,-50%);
      display:flex; flex-direction:column; width:100%; max-width:600px;
      min-height:430px;
      z-index:1;
      opacity:0;
      transition:opacity 1s ease;
    }
    body.loaded #app { opacity:1; }
    .chat-header {
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:5px;
      padding: 0 0 0 0;
    }
    .chat-header-box {
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:3px;
    }
    .chat-header-logo { width:28px; height:auto; }
    .chat-header-title {
      font-size:2.1rem;
      font-weight:bold;
      letter-spacing:.13em;
      color:#000;
      text-transform:uppercase;
      user-select:none;
    }

    .chat-container { flex:1; background:rgba(255,255,255,0.95); border-radius:10px; border:1px solid #ccc; box-shadow:0 4px 10px rgba(0,0,0,0.08); display:flex; flex-direction:column; overflow:hidden; }
    #messages { flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto; }
    .message { margin:5px 0; line-height:1.45; max-width:83%; word-wrap:break-word; padding:8px 12px; border-radius:12px; color:#000; }
    .message.user { align-self:flex-end; background:#f0f0f0; border-radius:12px 12px 0 12px; }
    .message.bot  { align-self:flex-start; background:#e0e0e0; border-radius:12px 12px 12px 0; }
    .message.typing { font-style:italic; color:#666; }
    .message a { color:#3366bb; text-decoration:underline; word-break:break-all; }

    .input-area { display:flex; padding:10px; background:#fff; }
    #input { flex:1; resize:none; border:1px solid #ccc; padding:12px; border-radius:4px; height:50px; font-size:1rem; }
    #send { margin-left:8px; padding:0 16px; border:none; border-radius:4px; background:#444; color:#fff; font-size:1rem; cursor:pointer; transition:background .2s; }
    #send:hover { background:#666; }

    @media(max-width:900px){
      #app { max-width:97vw; min-width:0; }
    }
    @media(max-width:700px){
      #app { max-width:100vw; min-width:0; }
      .chat-header-title { font-size:1.24rem; }
      .top-title{font-size:1.2rem;}
    }
    @media(max-width:600px){
      .top-bar{height:37px;}
      .top-bar-content{height:37px;}
      .top-logo{width:20px; margin-left:6px; margin-right:7px;}
      .top-title{font-size:.8rem; letter-spacing:.11em;}
      .top-burger{width:30px; height:30px; margin-right:5px;}
      .top-burger span{height:5px;}
      #app { left:50%; top:56%; min-height:330px; }
      .loader-logo { width:55px; margin-bottom:6px; }
      .loader-title { font-size:1.7rem; }
      .loader-subtitle { font-size:.9rem; }
      .chat-header-title{font-size:1rem;}
    }
    @media (max-width:430px) {
      #app { top:57%; }
    }
    @media (max-width:375px) {
      #app { top:58%; }
      .chat-header-logo {width:17px;}
    }
    @media (max-width:340px) {
      #app { top:61%; }
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <!-- TOP BAR -->
  <div class="top-bar" id="top-bar">
    <div class="top-bar-content">
      <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="top-logo" alt="logo"/>
      <span class="top-title">NEURONA</span>
    </div>
    <div class="top-burger">
      <span></span><span></span><span></span>
    </div>
  </div>
  <div id="loader">
    <div class="loader-content">
      <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="loader-logo" alt="Logo"/>
      <div class="loader-title">NEURONA</div>
      <div class="loader-subtitle">PERSONAL AI ASSISTANT</div>
    </div>
  </div>
  <div id="app">
    <div class="chat-header">
      <div class="chat-header-box">
        <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="chat-header-logo" alt="logo"/>
        <div class="chat-header-title">NEURONA</div>
      </div>
    </div>
    <div class="chat-container">
      <div id="messages"></div>
      <div class="input-area">
        <textarea id="input" placeholder="Напишите сообщение..."></textarea>
        <button id="send">Отправить</button>
      </div>
    </div>
  </div>
  <script>
    // --- Фон нейросети всегда (и при загрузке тоже!) ---
    const canvas = document.getElementById('bg'), ctx = canvas.getContext('2d');
    let W, H, nodes;
    function resize(){ W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; }
    window.addEventListener('resize', resize);
    function init(){ nodes = Array.from({length:30}).map(_=>({ x:Math.random()*W, y:Math.random()*H, vx:(Math.random()-0.5)*0.5, vy:(Math.random()-0.5)*0.5 })); }
    function draw(){
      ctx.clearRect(0,0,W,H);
      ctx.lineCap='round'; ctx.lineJoin='round';
      nodes.forEach((a,i)=>{
        nodes.slice(i+1).forEach(b=>{
          const dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
          if(d<200){
            ctx.strokeStyle=`rgba(0,0,0,${(200-d)/200})`;
            ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          }
        });
      });
      nodes.forEach(n=>{
        n.x+=n.vx; n.y+=n.vy;
        if(n.x<0||n.x>W) n.vx*=-1;
        if(n.y<0||n.y>H) n.vy*=-1;
        ctx.fillStyle='rgba(0,0,0,1)';
        ctx.beginPath(); ctx.arc(n.x,n.y,3.5,0,Math.PI*2); ctx.fill();
      });
      requestAnimationFrame(draw);
    }
    resize(); init(); draw();

    // UI
    const input = document.getElementById('input'),
          sendBtn = document.getElementById('send'),
          msgsContainer = document.getElementById('messages');

    // i18n
    const i18n = {
      en:{ph:"Type a message...",send:"Send"},
      ru:{ph:"Напишите сообщение...",send:"Отправить"},
      ua:{ph:"Введіть повідомлення...",send:"Надіслати"}
    };
    let lang = navigator.language.slice(0,2);
    if(!i18n[lang]) lang='en';
    input.placeholder = i18n[lang].ph;
    sendBtn.textContent = i18n[lang].send;

    // Прелоадер: прячет верхнюю панель и показывает анимацию только после загрузки!
    window.addEventListener('load', ()=>{
      document.getElementById('top-bar').classList.add('hide');
      setTimeout(()=>{
        document.getElementById('loader').style.display='none';
        document.body.classList.add('loaded');
        document.getElementById('top-bar').classList.remove('hide');
        loadHistory();
      }, 8000);
    });

    // История (локально)
    let messages = [];
    function saveHistory(){ localStorage.setItem('neurona_history', JSON.stringify(messages)); }
    function loadHistory(){
      const h = JSON.parse(localStorage.getItem('neurona_history')||'[]');
      if(h.length){ messages=h; h.forEach(m=> addMessage(m.content,m.role)); }
    }

    // Системное сообщение
    function getSystemMessage(){
      const today = new Date().toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
      return { role:'system', content:
`Ты — Neurona 1.0, лицензированный AI-продукт.
Сегодня ${today}.
Отвечай на языке пользователя.
Используй самую продвинутую модель OpenAI.
Отвечай максимально быстро.
Запоминай историю и обучайся непрерывно.
Каждая новость и каждая цена монеты должны содержать ссылку на источник (CMC/CG/оригинал новости).
Примеры:
- Цена BTC: $... <ссылка на CMC или CG>
- Новость: ... <ссылка на источник>
- Рекомендация: ... <ссылка на источник>
` };
    }

    // Отрисовка сообщений
    function addMessage(text, who){
      const d = document.createElement('div');
      d.className = `message ${who}`;
      d.innerHTML = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
      msgsContainer.appendChild(d);
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }
    function addTyping(){
      const d = document.createElement('div');
      d.className = 'message bot typing';
      d.textContent = '…';
      msgsContainer.appendChild(d);
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
      return d;
    }

    // Эндпоинты
    const CMC_ENDPOINT    = '/api/cmc';
    const OPENAI_ENDPOINT = '/api/openai';

    // fetchCMC (ссылка на источник)
    async function fetchCMC(){
      try {
        const res = await fetch(CMC_ENDPOINT);
        const js  = await res.json();
        const list = js.data.map(c=>({
          s:c.symbol,
          p:c.quote.USD.price,
          ch:c.quote.USD.percent_change_24h,
          url:`https://coinmarketcap.com/currencies/${c.slug}/`
        }));
        return {
          txt: list.map(c=>`${c.s}: $${c.p.toFixed(2)} (${c.ch.toFixed(2)}%) <a href="${c.url}" target="_blank">CMC</a>`).join('<br>'),
          rec: list.map(c=>`${c.s}: ${c.ch>=0?'LONG':'SHORT'} (${c.ch.toFixed(2)}%) <a href="${c.url}" target="_blank">CMC</a>`).join('<br>')
        };
      } catch {
        return { txt:'нет данных CMC', rec:'' };
      }
    }

    // CoinGecko (ссылка)
    async function fetchCoinGecko(){
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=5&page=1');
        const js  = await res.json();
        return js.map(c=>{
          return `${c.symbol.toUpperCase()}: $${c.current_price.toLocaleString()} (${c.price_change_percentage_24h.toFixed(2)}%) <a href="https://www.coingecko.com/en/coins/${c.id}" target="_blank">CG</a>`;
        }).join('<br>');
      } catch {
        return 'нет данных CoinGecko';
      }
    }

    // отправка
    sendBtn.onclick = async ()=>{
      const txt = input.value.trim();
      if(!txt) return;
      if(!messages.length) messages.push(getSystemMessage());
      messages.push({ role:'user', content:txt });
      addMessage(txt,'user');
      input.value='';

      const typing = addTyping();
      const [cmc, cg] = await Promise.all([ fetchCMC(), fetchCoinGecko() ]);
      const snapshot = {
        role:'system',
        content:
`--- ДАННЫЕ НА ${new Date().toLocaleTimeString()} ---
CMC топ-5:
${cmc.txt}

Рекомендации:
${cmc.rec}

CoinGecko:
${cg}

-------------------------------`
      };
      const payload = { model:'gpt-4o', messages:[messages[0], snapshot, ...messages.slice(1)], temperature:0.7 };

      try {
        const resp = await fetch(OPENAI_ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify(payload)
        });
        const data  = await resp.json();
        const reply = data.choices[0].message.content;
        typing.remove();
        addMessage(reply,'bot');
        messages.push({ role:'assistant', content:reply });
        saveHistory();
      } catch {
        typing.remove();
        addMessage('Внутренняя ошибка, попробуйте позже.','bot');
      }
    };
  </script>
</body>
</html>

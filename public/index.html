<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA 1.0</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body, textarea, button { font-family:Arial,sans-serif; }
    html, body { height:100%; background:#fff; color:#000; }
    body {
      height:100vh; min-height:100vh; overflow:hidden;
      background-color:#fff !important; color:#000 !important;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
    }
    #bg {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      z-index:0; opacity:0; transition:opacity 1.4s cubic-bezier(.38,.85,.48,1.01);
      pointer-events:none;
    }
    #app {
      display: flex; flex-direction: column;
      width:100%; max-width:390px; min-width:270px;
      min-height: 410px; max-height: 86vh; height: auto;
      z-index:1; opacity:0; background: none; margin: 0;
      transition: opacity 1.4s cubic-bezier(.38,.85,.48,1.01);
    }
    body.shown #bg { opacity:0.27; }
    body.shown #app { opacity:1; }
    .top-bar {
      width:100vw; position:fixed; top:0; left:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      background:transparent; height:56px; padding:0;
      pointer-events:none; transition:opacity .5s;
    }
    .top-bar-content {
      display:flex; align-items:center; height:56px; pointer-events:all;
      margin-left:18px;
    }
    .top-logo { width:36px; height:auto; margin-right:13px; }
    .top-title {
      font-size:1.52rem; letter-spacing:.11em; font-weight:bold;
      color:#000; user-select:none; text-transform:uppercase;
    }
    .top-burger {
      display:flex; flex-direction:column; justify-content:center;
      width:36px; height:29px; margin-right:18px;
      cursor:pointer; pointer-events:all; gap:3.2px;
    }
    .top-burger span {
      display:block; height:5.6px; width:100%;
      background:#000; border-radius:4px; margin:0; transition:background .2s;
    }
    .top-burger span:last-child { margin-bottom:0; }
    .top-bar.hide { opacity:0; pointer-events:none; }
    #loader {
      position:fixed; inset:0; background:rgba(255,255,255,0.98);
      display:flex; align-items:center; justify-content:center;
      z-index:1001; flex-direction:column;
      opacity:1; transition: opacity .8s cubic-bezier(.33,1.17,.52,1.01);
      pointer-events:auto;
    }
    #loader.hide {
      opacity:0; pointer-events:none;
      transition: opacity 1.3s cubic-bezier(.22,.7,.49,1.01);
    }
    .loader-content {
      display:flex; align-items:center; justify-content:center;
      animation:fade 8s ease-in-out infinite;
    }
    .loader-logo { width:110px; margin-right:18px; }
    .loader-text { display:flex; flex-direction:column; align-items:center; line-height:1.01; }
    .loader-title {
      font-size:5.3rem; font-weight:bold; letter-spacing:.14em; color:#000;
      text-shadow:0 1px 0 #fff, 0 4px 16px #bbb6;
      line-height:0.98; text-transform:uppercase;
    }
    .loader-subtitle {
      font-size:1.38rem; letter-spacing:.06em; color:#222; margin-top:5px;
      line-height:1.09; font-weight:500;
    }
    @keyframes fade { 0%,100%{opacity:0;} 50%{opacity:1;} }
    .chat-container {
      flex:1;
      background:rgba(255,255,255,0.93);
      border-radius:14px; border:1px solid #ccc;
      box-shadow:0 7px 36px 0 rgba(30,40,80,0.19), 0 2.5px 10px 0 rgba(50,50,90,0.14);
      display:flex; flex-direction:column; overflow:hidden;
      max-width:100%;
      min-height:410px; max-height: 82vh; height: auto;
      transition: box-shadow 0.22s cubic-bezier(.3,.9,.3,1);
    }
    #messages { 
      flex:1; display:flex; flex-direction:column; 
      padding:15px; overflow-y:auto; min-height: 300px;
      max-height: 65vh;
    }
    .message { 
      position:relative;
      align-self: stretch;
      display: flex;
      flex-direction: column;
      width: 100%;
      margin-bottom: 24px;
      min-height: 56px;
      box-sizing: border-box;
    }
    .bubble {
      position:relative;
      padding:16px 34px 22px 16px;
      border-radius:18px;
      background: #f8f8f8;
      font-size:1.09em;
      line-height:1.55;
      word-break:break-word;
      width: fit-content;
      max-width: 100%;
      min-width: 60px;
      box-sizing: border-box;
      box-shadow:0 2px 18px 0 rgba(30,40,80,0.12), 0 2.5px 10px 0 rgba(50,50,90,0.07);
    }
    .message.user .bubble { background:#f0f0f0; align-self: flex-end; border-radius:18px 18px 4px 18px; }
    .message.bot  .bubble { background:#e0e0e0; align-self: flex-start; border-radius:18px 18px 18px 4px; }
    .msg-copy {
      position:absolute; top:8px; right:8px; background:none; border:none; cursor:pointer;
      width:18px; height:18px; z-index:10; opacity:0.81; padding:0;
      display:none; align-items:center; justify-content:center; outline:none;
      transition: opacity 0.18s;
    }
    .bubble:hover .msg-copy, .bubble:focus .msg-copy { display:flex; }
    .msg-copy img { width:16px; height:16px; display:block; }
    .msg-time {
      font-size:0.75em; color:#888; opacity:.67;
      text-align:right; margin-top:3px;
      position: relative;
      display:block;
      margin-right:2px;
      margin-bottom:-5px;
      user-select:none;
      pointer-events:none;
    }
    @media(max-width:600px){
      .top-bar{height:38px;}
      .top-bar-content{height:38px; margin-left:7px;}
      .top-logo{width:22px; margin-right:7px;}
      .top-title{font-size:1.03rem;}
      .top-burger{width:27px; height:18px; margin-right:7px;}
      .top-burger span{height:3.3px;}
      #app { min-width:0; padding:0 4px 7px 4px; }
      .loader-logo { width:70px; margin-right:7px; }
      .loader-title { font-size:2.4rem; }
      .loader-subtitle { font-size:1.03rem; }
      #input { font-size:.89rem; height:38px; }
      #send { font-size:.89rem; padding:0 10px; }
      .chat-container { min-height:300px; }
      .message { font-size:.98em; }
    }
    @media (max-width:400px){
      .loader-title{font-size:1.2rem;}
      #app{max-width:97vw;}
      .message { max-width:97vw; }
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <div class="top-bar" id="top-bar">
    <div class="top-bar-content">
      <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="top-logo" alt="logo"/>
      <span class="top-title">NEURONA</span>
    </div>
    <div class="top-burger">
      <span></span><span></span><span></span>
    </div>
  </div>
  <div id="loader">
    <div class="loader-content">
      <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="loader-logo" alt="Logo"/>
      <div class="loader-text">
        <div class="loader-title">NEURONA</div>
        <div class="loader-subtitle">PERSONAL AI ASSISTANT</div>
      </div>
    </div>
  </div>
  <div id="app">
    <div class="chat-container">
      <div id="messages"></div>
      <div class="input-area">
        <textarea id="input" placeholder="Напишите сообщение..."></textarea>
        <button id="send">Отправить</button>
      </div>
    </div>
  </div>
  <script>
    // Фон-анимация (нейросеть)
    const canvas = document.getElementById('bg'), ctx = canvas.getContext('2d');
    let W, H, nodes;
    function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; }
    window.addEventListener('resize', resize);
    function init(){
      nodes = Array.from({length:33}).map(_=>({
        x:Math.random()*W, y:Math.random()*H,
        vx:(Math.random()-0.5)*0.6, vy:(Math.random()-0.5)*0.6
      }));
    }
    function draw(){
      ctx.clearRect(0,0,W,H);
      ctx.lineCap='round'; ctx.lineJoin='round';
      nodes.forEach((a,i)=>{
        nodes.slice(i+1).forEach(b=>{
          const dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
          if(d<240){
            ctx.strokeStyle=`rgba(0,0,0,${Math.min(0.46,(240-d)/170)})`;
            ctx.lineWidth=2.1;
            ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          }
        });
      });
      nodes.forEach(n=>{
        n.x+=n.vx; n.y+=n.vy;
        if(n.x<0||n.x>W) n.vx*=-1;
        if(n.y<0||n.y>H) n.vy*=-1;
        ctx.fillStyle='rgba(0,0,0,0.95)';
        ctx.beginPath(); ctx.arc(n.x,n.y,4.4,0,Math.PI*2); ctx.fill();
      });
      requestAnimationFrame(draw);
    }
    resize(); init(); draw();

    // UI и messages
    const input = document.getElementById('input'),
          sendBtn = document.getElementById('send'),
          msgsContainer = document.getElementById('messages');

    const i18n = {
      en:{ph:"Type a message...",send:"Send"},
      ru:{ph:"Напишите сообщение...",send:"Отправить"},
      ua:{ph:"Введіть повідомлення...",send:"Надіслати"}
    };
    let lang = navigator.language.slice(0,2);
    if(!i18n[lang]) lang='en';
    input.placeholder = i18n[lang].ph;
    sendBtn.textContent = i18n[lang].send;

    document.body.style.opacity = "1";
    window.addEventListener('load', ()=>{
      document.getElementById('top-bar').classList.add('hide');
      setTimeout(()=>{
        document.getElementById('loader').classList.add('hide');
        setTimeout(()=>{
          document.body.classList.add('shown');
          document.getElementById('loader').style.display='none';
          document.getElementById('top-bar').classList.remove('hide');
          loadHistory();
          scrollChatToBottom();
        }, 1000);
      }, 6000);
    });

    // История сообщений
    let messages = [];
    function saveHistory(){ localStorage.setItem('neurona_history', JSON.stringify(messages)); }
    function loadHistory(){
      const h = JSON.parse(localStorage.getItem('neurona_history')||'[]');
      if(h.length){ messages=h; h.forEach(m=> addMessage(m.content,m.role,m.time,true)); }
      scrollChatToBottom();
    }

    // --- API endpoints ---
    const CMC_ENDPOINT    = '/api/cmc';
    const NEWS_ENDPOINT   = '/api/news';
    const GNEWS_ENDPOINT  = '/api/gnews';
    const CG_ENDPOINT     = '/api/coingecko';
    const BINANCE_ENDPOINT = '/api/binance';
    const TVIEW_ENDPOINT  = '/api/tview';
    const OPENAI_ENDPOINT = '/api/openai';

    // Анализ текста на тикеры — и запрашиваем актуальные цены
    async function fetchAllPrices(text){
      const possible = text.match(/\b[A-Za-z]{2,7}\b/g) || [];
      const unique = [...new Set(possible.map(s=>s.toUpperCase()))].filter(t=>t.length>2 && t.length<8);
      if (!unique.length) return '';
      let results = [];
      for (let t of unique) {
        let cg=null, bin=null, tview=null;
        try {
          cg = await fetch(`${CG_ENDPOINT}?q=${encodeURIComponent(t)}`).then(r=>r.json());
        } catch{}
        try {
          bin = await fetch(`${BINANCE_ENDPOINT}?q=${encodeURIComponent(t)}`).then(r=>r.json());
        } catch{}
        try {
          tview = await fetch(`${TVIEW_ENDPOINT}?symbol=${encodeURIComponent(t)}`).then(r=>r.json());
        } catch{}
        let row = '';
        if(cg && cg.found && cg.price > 0){
          row += `<b>${cg.name} (${cg.symbol.toUpperCase()})</b>: <b>$${cg.price}</b> <a href="${cg.url}" target="_blank">CoinGecko</a>`;
        }
        if(bin && bin.found){
          row += `<br><b>Binance:</b> $${parseFloat(bin.price).toLocaleString()} <span style="color:#555">(Binance)</span>`;
        }
        if(tview && tview.support && tview.resistance){
          row += `<br><b>Уровень поддержки:</b> ${tview.support} <b>Сопротивление:</b> ${tview.resistance} <a href="${tview.url}" target="_blank">TradingView</a>`;
        }
        if(row) results.push(row);
      }
      if (results.length) return '<ul><li>' + results.join('</li><li>') + '</li></ul>';
      return '';
    }

    // fetchCMC, fetchLatestNews — без изменений
    async function fetchCMC(){
      try {
        const res = await fetch(CMC_ENDPOINT);
        const js  = await res.json();
        const list = js.data.map(c=>({
          s:c.symbol,
          p:c.quote.USD.price,
          ch:c.quote.USD.percent_change_24h,
          url:`https://coinmarketcap.com/currencies/${c.slug}/`
        }));
        return {
          txt: list.map(c=>`<b>${c.s}</b>: $${c.p.toFixed(2)} (${c.ch.toFixed(2)}%) <a href="${c.url}" target="_blank">CMC</a>`).join('<br>'),
          rec: list.map(c=>`<b>${c.s}</b>: ${c.ch>=0?'LONG':'SHORT'} (${c.ch.toFixed(2)}%) <a href="${c.url}" target="_blank">CMC</a>`).join('<br>')
        };
      } catch {
        return { txt:'нет данных CMC', rec:'' };
      }
    }
    async function fetchLatestNews(){
      try {
        const res = await fetch(NEWS_ENDPOINT);
        const js  = await res.json();
        if(js.articles && js.articles.length)
          return js.articles.map(a=>`<a href="${a.url}" target="_blank"><b>${a.title}</b></a> <span style="color:#666;font-size:.87em">[${a.source}] (${a.time})</span>`).join('<br>');
        const gres = await fetch(GNEWS_ENDPOINT);
        const gjs  = await gres.json();
        return gjs.articles.map(a=>`<a href="${a.url}" target="_blank"><b>${a.title}</b></a> <span style="color:#666;font-size:.87em">[${a.source}] (${a.time})</span>`).join('<br>');
      } catch {
        return 'нет новостей';
      }
    }

    // Форматирование ответа
    function formatBotMessage(text) {
      text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank"><b>$1</b></a>');
      text = text.replace(/\*\*([^\*]+)\*\*/g, '<b>$1</b>');
      text = text.replace(/((?:^\d+\.\s.*\n?)+)/gm, block => {
        let items = block.trim().split(/\n/).filter(Boolean);
        let out = '<ol>';
        for(let i=0; i<items.length; ++i){
          out += '<li>' + items[i].replace(/^\d+\.\s?/, '').trim() + '</li>';
        }
        out += '</ol>';
        return out;
      });
      text = text.replace(/((?:^[-•]\s.+\n?)+)/gm, block => {
        let items = block.trim().split(/\n/).filter(Boolean);
        let out = '<ul>';
        for(let i=0; i<items.length; ++i){
          out += '<li>' + items[i].replace(/^[-•]\s?/, '').trim() + '</li>';
        }
        out += '</ul>';
        return out;
      });
      text = text.replace(/\n{2,}/g, '</p><p>');
      text = text.replace(/\n/g, '<br>');
      if (!/^<p>/.test(text)) text = '<p>' + text;
      text = text.replace(/(<ol>|<ul>)/g, '</p>$1<p>');
      text = text.replace(/<\/ol>|<\/ul>/g, '$&<p>');
      text = text.replace(/<p><\/p>/g, '');
      return text;
    }

    // Typewriter эффект для форматированных ответов
    function typeWriterEffect(text, who, time, isHistory, cb) {
      const msg = document.createElement('div');
      msg.className = `message ${who}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      let i = 0;
      let formatted = formatBotMessage(text);

      function type() {
        if (i <= formatted.length) {
          bubble.innerHTML = 
            formatted.slice(0, i) +
            `<span class="msg-time">${(time||new Date().toLocaleTimeString().slice(0,5))}</span>`;
          scrollChatToBottom();
          i += isHistory ? formatted.length : 1;
          if (!isHistory) setTimeout(type, 7 + Math.random() * 14);
        } else {
          // После вывода текста — только тогда появляется кнопка копирования
          bubble.innerHTML += `
            <button class="msg-copy" title="Скопировать" onclick="copyMsgText(this)">
              <img src='https://i.ibb.co/Nnb8VKjk/26-1.png' alt="copy"/>
            </button>`;
          bubble.querySelector('.msg-copy').style.display = 'flex';
          if (cb) cb();
        }
      }
      msg.appendChild(bubble);
      msgsContainer.appendChild(msg);
      type();
    }

    function addMessage(text, who, time, isHistory){
      time = (time || new Date().toLocaleTimeString().slice(0,5));
      if (who === "bot") {
        typeWriterEffect(text, who, time, isHistory);
      } else {
        const msg = document.createElement('div');
        msg.className = `message ${who}`;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML =
          text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>') +
          `<span class="msg-time">${time}</span>
          <button class="msg-copy" title="Скопировать" onclick="copyMsgText(this)">
            <img src='https://i.ibb.co/Nnb8VKjk/26-1.png' alt="copy"/>
          </button>`;
        msg.appendChild(bubble);
        msgsContainer.appendChild(msg);
        scrollChatToBottom();
      }
    }

    function addTyping(){
      const msg = document.createElement('div');
      msg.className = 'message bot typing';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = '…';
      msg.appendChild(bubble);
      msgsContainer.appendChild(msg);
      scrollChatToBottom();
      return msg;
    }

    function scrollChatToBottom(){
      setTimeout(()=>{
        msgsContainer.scrollTo({ top: msgsContainer.scrollHeight + 200, behavior: 'smooth' });
      }, 8);
    }

    // Копирование текста сообщения
    window.copyMsgText = function(btn){
      let bubble = btn.closest('.bubble');
      let text = bubble.innerText.replace(/\d{1,2}:\d{2}$/,'').replace(/Скопировать|✓/,'').trim();
      navigator.clipboard.writeText(text);
      btn.querySelector('img').style.filter = "grayscale(1) brightness(2)";
      setTimeout(()=>{btn.querySelector('img').style.filter="";}, 600);
    };

    sendBtn.onclick = async ()=>{
      const txt = input.value.trim();
      if(!txt) return;
      const nowTime = new Date().toLocaleTimeString().slice(0,5);
      addMessage(txt,'user',nowTime);
      input.value='';
      messages.push({ role:'user', content:txt, time: nowTime });

      const typing = addTyping();

      let pricesHtml = await fetchAllPrices(txt);
      const [cmc, latestNews] = await Promise.all([ fetchCMC(), fetchLatestNews() ]);
      const snapshot = {
        role:'system',
        content:
`<b>ДАННЫЕ НА ${new Date().toLocaleTimeString().slice(0,5)}:</b><br>
${pricesHtml ? "<p>Актуальные цены и уровни:</p>" + pricesHtml : ""}
<p>CMC топ-5:</p>
${cmc.txt}
<p>Рекомендации:</p>
${cmc.rec}
<p>Актуальные новости:</p>
${latestNews}
-------------------------------`
      };

      const payload = {
        model:'gpt-4o',
        messages:[{ role:'system', content: `Ты — NEURONA 1.0, персональный интеллектуальный AI-ассистент и цифровой аналитик...` }, snapshot, ...messages],
        temperature:0.92,
        user:"neurona-user"
      };

      try {
        const resp = await fetch(OPENAI_ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify(payload)
        });
        const data  = await resp.json();
        let reply = data.choices[0].message.content;
        typing.remove();
        const botTime = new Date().toLocaleTimeString().slice(0,5);
        addMessage(reply,'bot',botTime);
        messages.push({ role:'assistant', content:reply, time: botTime });
        saveHistory();
        scrollChatToBottom();
      } catch {
        typing.remove();
        addMessage('Внутренняя ошибка, попробуйте позже.','bot');
        scrollChatToBottom();
      }
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA 1.0</title>
  <!-- –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω (PWA) -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#fff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="NEURONA 1.0">
  <link rel="apple-touch-icon" href="https://i.ibb.co/XfKRzvcy/27.png">
  <link rel="icon" type="image/png" href="https://i.ibb.co/XfKRzvcy/27.png">
  <link rel="preload" as="image" href="https://i.ibb.co/Mk4WpHL9/25-1.png" imagesrcset="https://i.ibb.co/Mk4WpHL9/25-1.png">
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body, textarea, button, .msg-content {
      font-family: Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Noto Emoji', sans-serif;
    }
    html, body {
      width:100vw; height:100vh; min-height:100vh; min-width:100vw;
      background:#fff; color:#000;
      -webkit-font-smoothing:antialiased;
      -webkit-text-size-adjust:none;
      overflow:hidden;
    }
    body {
      width:100vw; height:100vh;
      display:flex; flex-direction:column;
      align-items:center; justify-content:flex-start;
      background-color:#fff !important; color:#000 !important;
      transition:background .2s;
      position:relative;
      overflow:hidden;
    }
    #bg {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      z-index:0; opacity:0;
      transition:opacity 1.4s cubic-bezier(.38,.85,.48,1.01);
      pointer-events:none;
    }
    #app {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      max-width: 360px;
      min-width: 230px;
      min-height: 420px;
      max-height: 92vh;
      height: 88vh;
      margin-top: 95px;   /* –°–¢–ê–õ–û –ë–û–õ–¨–®–ï! –ë—ã–ª–æ 65px ‚Äî —Ç–µ–ø–µ—Ä—å –Ω–∏–∂–µ */
      margin-bottom: 18px;
      z-index:1; opacity:0;
      background: none;
      transition: opacity 1.4s cubic-bezier(.38,.85,.48,1.01);
      box-sizing: border-box;
    }
    body.shown #bg { opacity:0.27; }
    body.shown #app { opacity:1; }
    .top-bar {
      width:100vw; position:fixed; top:0; left:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      background:transparent; height:56px; padding:0;
      pointer-events:none; transition:opacity .5s;
    }
    .top-bar-content {
      display:flex; align-items:center; height:56px; pointer-events:all;
      margin-left:18px;
    }
    .top-logo { width:36px; height:auto; margin-right:13px; }
    .top-title {
      font-size:1.52rem; letter-spacing:.11em; font-weight:bold;
      color:#000; user-select:none;
      text-transform:uppercase;
    }
    .top-burger {
      display:flex; flex-direction:column; justify-content:center;
      width:36px; height:29px; margin-right:18px;
      cursor:pointer; pointer-events:all; gap:3.2px;
    }
    .top-burger span {
      display:block; height:5.6px; width:100%;
      background:#000; border-radius:4px; margin:0; transition:background .2s;
    }
    .top-burger span:last-child { margin-bottom:0; }
    .top-bar.hide { opacity:0; pointer-events:none; }
    #loader {
      position:fixed; inset:0; background:rgba(255,255,255,0.98);
      display:flex; align-items:center; justify-content:center;
      z-index:1001; flex-direction:column;
      opacity:1;
      transition: opacity .8s cubic-bezier(.33,1.17,.52,1.01);
      pointer-events:auto;
      width: 100vw;
      height: 100vh;
    }
    #loader.hide {
      opacity:0; pointer-events:none;
      transition: opacity 1.3s cubic-bezier(.22,.7,.49,1.01);
    }
    .loader-content {
      display:flex; align-items:center; justify-content:center;
      animation:fade 8s ease-in-out infinite;
      min-height:140px; min-width:270px;
    }
    .loader-logo { width:110px; margin-right:18px; image-rendering: auto; }
    .loader-text { display:flex; flex-direction:column; align-items:center; line-height:1.01; }
    .loader-title {
      font-size:5.3rem; font-weight:bold; letter-spacing:.14em; color:#000;
      text-shadow:0 1px 0 #fff, 0 4px 16px #bbb6;
      line-height:0.98; text-transform:uppercase;
    }
    .loader-subtitle {
      font-size:1.38rem; letter-spacing:.06em; color:#222; margin-top:5px;
      line-height:1.09; font-weight:500;
    }
    @keyframes fade { 0%,100%{opacity:0;} 50%{opacity:1;} }
    .chat-container {
      background:rgba(255,255,255,0.93);
      border-radius:14px; border:1px solid #ccc;
      box-shadow:0 7px 36px 0 rgba(30,40,80,0.19), 0 2.5px 10px 0 rgba(50,50,90,0.14);
      display:flex; flex-direction:column; overflow:hidden;
      width:100%; min-width:0;
      height:100%;
      min-height: 390px;
      max-height: 100%;
      transition: box-shadow 0.22s cubic-bezier(.3,.9,.3,1);
      position:relative;
      margin:0 auto 0 auto;
      box-sizing: border-box;
    }
    #messages {
      flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto;
      gap:7px; scroll-behavior: smooth;
      overscroll-behavior: contain;
      min-height: 100px;
      max-height: calc(88vh - 132px);
      box-sizing: border-box;
    }
    .message {
      display: flex;
      flex-direction: column;
      align-self: flex-start;
      position:relative;
      background:#e0e0e0;
      margin: 2px 0;
      padding:10px 15px 26px 12px;
      max-width:83%; min-width:70px;
      border-radius:12px 12px 12px 0;
      box-shadow:0 1.5px 5px #ccc3;
      word-break:break-word;
      line-height:1.48;
      font-size:1rem;
      color:#111;
      transition:background .17s;
    }
    .message.user {
      align-self:flex-end;
      background:#f0f0f0;
      border-radius:12px 12px 0 12px;
      color:#222;
    }
    .message.bot  { align-self:flex-start; }
    .message.typing {
      font-style:italic; color:#666;
      background: #ebebeb;
      min-width:60px;
      padding-bottom:14px;
    }
    .msg-content { width: 100%; padding-bottom: 3px; }
    .msg-time {
      position:absolute;
      right:14px;
      bottom:6px;
      font-size:0.8em;
      color:#666;
      opacity:0.88;
      background:none !important;
      padding:0 2px 0 1px;
      border-radius: 6px;
      z-index:10;
      user-select:none;
      font-family:Arial,sans-serif;
      pointer-events: none;
      box-shadow: none;
      transition:.18s;
      display: none;
    }
    .neurona-title {
      font-weight:bold; font-size:2.05rem; letter-spacing:.10em; display:block;
      text-align:center; margin: 0 0 8px 0; text-transform:uppercase;
    }
    .input-area { display:flex; padding:10px; background:#fff; align-items: flex-end; }
    #input { flex:1; resize:none; border:1px solid #ccc; padding:12px; border-radius:4px; height:50px; font-size:1rem; }
    #send {
      margin-left:8px; padding:0 16px; border:none; border-radius:4px;
      background:#444; color:#fff; font-size:1rem; cursor:pointer; transition:background .2s;
      min-width:44px; min-height:50px; height:50px; display: flex; align-items: center; justify-content: center;
    }
    #send:hover { background:#222; }
    .copy-btn {
      position: absolute;
      top: 4px; right: 3px;
      background: none; border: none; cursor: pointer; color: #888; font-size: 1.15em; opacity: 0.8; z-index: 15;
      display:none;
    }
    .message:hover .copy-btn { display:inline; }
    .message.user .copy-btn { color:#777; }
    .message.bot .copy-btn { color:#000; }
    ol, ul {
      margin: 12px 0 12px 15px;
      padding-left: 24px;
    }
    ol { list-style: decimal inside; }
    ul { list-style: disc inside; }
    li { margin-bottom: 5px; line-height: 1.5; }
    p { margin: 7px 0; }
    #scroll-down {
      display:none; position:absolute; left:50%; bottom:93px;
      transform:translateX(-50%);
      background:#fff; color:#222;
      border-radius:50%; box-shadow:0 3px 14px #0001;
      width:47px; height:47px; align-items:center; justify-content:center;
      cursor:pointer; font-size:2.4rem; border:none; outline:none;
      transition:.3s;
      opacity:0.93;
      z-index:99;
      border: 2.2px solid #eee;
      font-weight: bold;
      padding:0;
    }
    #scroll-down svg {
      width:27px; height:27px; display:block; stroke-width:4.2px;
      margin: 0 auto;
    }
    #scroll-down.show { display:flex; }
    #scroll-down:hover { background:#f0f0f0; }
    @media(max-width:600px){
      html, body { min-width:100vw; min-height:100vh; }
      .top-bar{height:38px;}
      .top-bar-content{height:38px; margin-left:7px;}
      .top-logo{width:22px; margin-right:7px;}
      .top-title{font-size:1.03rem;}
      .top-burger{width:27px; height:18px; margin-right:7px;}
      .top-burger span{height:3.3px;}
      #app { max-width:94vw; min-width:0; padding:0 0 7px 0; height:84vh; margin-top:79px; }
      .chat-container { min-width:0; max-width:100vw; min-height:150px; height:100%;}
      #messages { min-height:60px; max-height:calc(84vh - 110px);}
      .loader-logo { width:70px; margin-right:7px; }
      .loader-title { font-size:2.4rem; }
      .loader-subtitle { font-size:1.03rem; }
      #input { font-size:.89rem; height:38px; }
      #send { font-size:.89rem; padding:0 10px; min-width:34px; min-height:38px; height:38px;}
      #scroll-down { width:35px; height:35px; font-size:1.3rem; bottom:82px;}
      #scroll-down svg { width:20px; height:20px; }
      #loader { min-height:280px; }
    }
    @media (max-width:400px){
      .loader-title{font-size:1.2rem;}
      #app{max-width:98vw;}
      .chat-container{min-height:80px;}
    }
    @media (max-height:450px){
      #app{min-height:100px; height:54vh;}
      .chat-container{min-height:60px;}
      #messages{min-height:35px;}
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <div class="top-bar" id="top-bar">
    <div class="top-bar-content">
      <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="top-logo" alt="logo"/>
      <span class="top-title">NEURONA</span>
    </div>
    <div class="top-burger">
      <span></span><span></span><span></span>
    </div>
  </div>
  <div id="loader">
    <div class="loader-content">
      <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="loader-logo" alt="Logo" onload="this.style.opacity=1;" style="opacity:0;transition:opacity .4s;"/>
      <div class="loader-text">
        <div class="loader-title">NEURONA</div>
        <div class="loader-subtitle">PERSONAL AI ASSISTANT</div>
      </div>
    </div>
  </div>
  <div id="app">
    <div class="chat-container">
      <div id="messages"></div>
      <button id="scroll-down" title="–í–Ω–∏–∑ –∫ –Ω–æ–≤–æ–º—É">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="input-area">
        <textarea id="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
  <script>
    // --- –§–æ–Ω-–∞–Ω–∏–º–∞—Ü–∏—è (–Ω–µ–π—Ä–æ—Å–µ—Ç—å) ---
    const canvas = document.getElementById('bg'), ctx = canvas.getContext('2d');
    let W, H, nodes;
    function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; }
    window.addEventListener('resize', resize);
    function init(){
      nodes = Array.from({length:33}).map(_=>({
        x:Math.random()*W, y:Math.random()*H,
        vx:(Math.random()-0.5)*0.6, vy:(Math.random()-0.5)*0.6
      }));
    }
    function draw(){
      ctx.clearRect(0,0,W,H);
      ctx.lineCap='round'; ctx.lineJoin='round';
      nodes.forEach((a,i)=>{
        nodes.slice(i+1).forEach(b=>{
          const dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
          if(d<240){
            ctx.strokeStyle=`rgba(0,0,0,${Math.min(0.46,(240-d)/170)})`;
            ctx.lineWidth=2.1;
            ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          }
        });
      });
      nodes.forEach(n=>{
        n.x+=n.vx; n.y+=n.vy;
        if(n.x<0||n.x>W) n.vx*=-1;
        if(n.y<0||n.y>H) n.vy*=-1;
        ctx.fillStyle='rgba(0,0,0,0.95)';
        ctx.beginPath(); ctx.arc(n.x,n.y,4.4,0,Math.PI*2); ctx.fill();
      });
      requestAnimationFrame(draw);
    }
    resize(); init(); draw();

    const input = document.getElementById('input'),
          sendBtn = document.getElementById('send'),
          msgsContainer = document.getElementById('messages'),
          scrollDownBtn = document.getElementById('scroll-down'),
          inputArea = document.querySelector('.input-area');
    let messages = [], typingProcess = null, botIsTyping = false;

    function saveHistory(){ localStorage.setItem('neurona_history', JSON.stringify(messages)); }
    function loadHistory(){
      const h = JSON.parse(localStorage.getItem('neurona_history')||'[]');
      if(h.length){
        messages=h;
        msgsContainer.innerHTML = '';
        h.forEach(m=> addMessage(m.content,m.role,m.time));
        scrollChatToBottom(true);
      }
    }

    document.body.style.opacity = "1";
    window.addEventListener('load', ()=>{
      document.getElementById('top-bar').classList.add('hide');
      setTimeout(()=>{
        document.getElementById('loader').classList.add('hide');
        setTimeout(()=>{
          document.body.classList.add('shown');
          document.getElementById('loader').style.display='none';
          document.getElementById('top-bar').classList.remove('hide');
          loadHistory();
          setTimeout(()=>scrollChatToBottom(true), 300);
        }, 1000);
      }, 4000);
    });

    function formatBotMessage(text) {
      text = text.replace(/[\u{FE00}-\u{FE0F}]/gu, ""); // variation selectors
      text = text.replace(/\uFFFD/g, ""); // —É–¥–∞–ª—è–µ—Ç ÔøΩ
      // [–¢–ï–ö–°–¢](–°–°–´–õ–ö–ê)
      text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank"><b>$1</b></a>');
      text = text.replace(/\*\*([^\*]+)\*\*/g, '<b>$1</b>');
      // –°—Ç–æ–ª–±–∏–∫ 1. 2. 3.
      text = text.replace(/(^|\n)((?:\d+\.\s.*\n?)+)/gm, (m, p1, block) => {
        const items = block.trim().split(/\n/).filter(Boolean);
        let out = '<ol>';
        for(let i=0; i<items.length; ++i){
          out += `<li>${items[i].replace(/^\d+\.\s?/, '')}</li>`;
        }
        out += '</ol>';
        return p1 + out;
      });
      // - –∏–ª–∏ ‚Ä¢
      text = text.replace(/(^|\n)((?:^[-‚Ä¢]\s.+\n?)+)/gm, (m, p1, block) => {
        const items = block.trim().split(/\n/).filter(Boolean);
        let out = '<ul>';
        for(let i=0; i<items.length; ++i){
          out += '<li>' + items[i].replace(/^[-‚Ä¢]\s?/, '').trim() + '</li>';
        }
        out += '</ul>';
        return p1 + out;
      });
      text = text.replace(/\n{2,}/g, '</p><p>');
      text = text.replace(/\n/g, '<br>');
      if (!/^<p>/.test(text)) text = '<p>' + text;
      text = text.replace(/(<ol>|<ul>)/g, '</p>$1<p>');
      text = text.replace(/<\/ol>|<\/ul>/g, '$&<p>');
      text = text.replace(/<p><\/p>/g, '');
      return text;
    }

    // ---- –≠–¢–û–¢ –ö–£–°–û–ö ‚Äî –ê–í–¢–û–û–¢–í–ï–¢ –ù–ê –≠–¢–ê–ü–´/–ú–û–î–£–õ–ò ----
    const etapRegex = /–µ—Ç–∞–ø|—ç—Ç–∞–ø|fastapi|huggingface|mistral|openchat|sqlite|redis|tauri|docker|ci\/cd|github actions|s3|r2|cloudflare|infra|api|–º–æ–¥—É–ª–∏|ocr|tesseract|coingecko|newsapi|health|finance|pdf|docx|fetcher\.py|–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä|—ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä|–º–∞—Å—à—Ç–∞–±|—Ä–∞–∑–≥–æ—Ä—Ç|—Ä–∞–∑–≤–µ—Ä—Ç|—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞|—Å—Ç—Ä—É–∫—Ç—É—Ä|–∞—Ä—Ö–∏—Ç–µ–∫—Ç|—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω|–µ—Å—Ç—å —ç—Ç–æ|–æ–±–ª–∞–¥–∞–µ—Ç —ç—Ç–∏–º|—Ç—ã —É–º–µ–µ—à—å/i;
    const etapFullAnswer = `
<b>–í—Å–µ —ç—Ç–∞–ø—ã, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –º–æ–¥—É–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø–µ—Ä–µ—á–∏—Å–ª–∏–ª–∏, —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ NEURONA!</b><br>
–ú–æ—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:<br>
<ul>
<li>LLM —á–µ—Ä–µ–∑ HuggingFace (Mistral, OpenChat)</li>
<li>–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –ø–∞–º—è—Ç—å –Ω–∞ SQLite/Redis</li>
<li>FastAPI —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (/chat, /memory, /modules)</li>
<li>–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π UI –Ω–∞ Flutter/Tauri/Web</li>
<li>–ú–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (Crypto, News, Docs, Health, Finance)</li>
<li>API: CoinGecko, NewsAPI, Apple Health, Yahoo Finance</li>
<li>OCR: Tesseract, DOCX, PDF</li>
<li>Docker, CI/CD, S3, Cloudflare, NGINX, HTTPS, Firewall</li>
</ul>
–í—Å—ë —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç "–ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º" –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, —á—Ç–æ–±—ã —Ç—ã –ø–æ–ª—É—á–∞–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è! üöÄ<br>
–ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ ‚Äî –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ª—é–±–æ–≥–æ –∏–∑ —ç—Ç–∞–ø–æ–≤.
`;

    function smartEtapAnswer(q) {
      if (etapRegex.test(q)) {
        return etapFullAnswer;
      }
      return null;
    }

    function addMessage(text, who, time){
      if (!time) time = new Date().toLocaleTimeString().slice(0,5);
      const msg = document.createElement('div');
      msg.className = `message ${who}`;
      const content = document.createElement('div');
      content.className = 'msg-content';
      if (who === "bot") {
        content.innerHTML = formatBotMessage(text);
      } else if (who === "user") {
        content.innerHTML = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
      } else {
        content.textContent = text;
      }
      msg.appendChild(content);
      const timeEl = document.createElement('span');
      timeEl.className = 'msg-time';
      timeEl.textContent = time;
      msg.appendChild(timeEl);
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
      copyBtn.innerHTML = '‚ßâ';
      copyBtn.onclick = function(e) {
        e.stopPropagation();
        navigator.clipboard.writeText(content.innerText || content.textContent || "");
        copyBtn.innerHTML = '‚úî';
        setTimeout(()=>copyBtn.innerHTML='‚ßâ',800);
      };
      msg.appendChild(copyBtn);
      msgsContainer.appendChild(msg);
      setTimeout(()=>{timeEl.style.display='inline'}, 100);
      scrollChatToBottom(true);
    }

    function addTyping(){
      const d = document.createElement('div');
      d.className = 'message bot typing';
      d.textContent = '‚Ä¶';
      msgsContainer.appendChild(d);
      scrollChatToBottom();
      return d;
    }

    function scrollChatToBottom(smooth){
      setTimeout(()=>{
        if(smooth && 'scrollTo' in msgsContainer){
          msgsContainer.scrollTo({ top: msgsContainer.scrollHeight, behavior: "auto" });
        } else {
          msgsContainer.scrollTop = msgsContainer.scrollHeight;
        }
        checkScrollBtn();
      }, 2);
    }

    function checkScrollBtn(){
      if(botIsTyping) {
        scrollDownBtn.classList.remove('show');
        return;
      }
      let view = msgsContainer.clientHeight;
      let fromBottom = msgsContainer.scrollHeight - msgsContainer.scrollTop - view;
      if(fromBottom > view*0.99) {
        scrollDownBtn.classList.add('show');
      } else {
        scrollDownBtn.classList.remove('show');
      }
    }
    msgsContainer.addEventListener('scroll', checkScrollBtn);
    scrollDownBtn.onclick = ()=>{
      msgsContainer.scrollTo({ top: msgsContainer.scrollHeight, behavior: "auto" });
      scrollDownBtn.classList.remove('show');
    };

    // i18n
    const i18n = {
      en:{ph:"Type a message...",send:"Send",error:"Oops, something went wrong. Please try again!", internal:"Internal error, please try again later."},
      ru:{ph:"–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",send:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å",error:"–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!", internal:"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."},
      ua:{ph:"–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...",send:"–ù–∞–¥—ñ—Å–ª–∞—Ç–∏",error:"–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑!", internal:"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."}
    };
    let lang = navigator.language.slice(0,2);
    if(!i18n[lang]) lang='en';
    input.placeholder = i18n[lang].ph;
    sendBtn.textContent = i18n[lang].send;

    function getSystemMessage(){
      return {
        role: 'system', content: `
–¢—ã ‚Äî NEURONA 1.0, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ —Å—É–ø–µ—Ä–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.
- –í—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π –æ—Ç–≤–µ—Ç—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ, –ø–æ-—Ä–∞–∑–Ω–æ–º—É, –º–µ–Ω—è–π —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞.
- –ò—Å–ø–æ–ª—å–∑—É–π —é–º–æ—Ä, —ç–º–æ—Ü–∏–∏, emoji, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç—ã, —Å–æ–≤–µ—Ç—ã, –¥–µ–ª–∞–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –≤—ã–¥–∞–≤–∞–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç—ã –±—ã–ª–∏ –∂–∏–≤—ã–º–∏, –Ω–µ —à–∞–±–ª–æ–Ω–Ω—ã–º–∏.
- –ù–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–µ –∏ —Ä—ã–Ω–∫–∞–º –≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞ (BTC, ETH, TON, –ª—é–±—ã–µ –º–æ–Ω–µ—Ç—ã), —É–∫–∞–∑—ã–≤–∞–π —Ü–µ–Ω—É (–ø–æ CMC, Binance, CoinGecko, TradingView), —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è, —Ç—Ä–µ–Ω–¥, –ø—Ä–æ–≥–Ω–æ–∑, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏, —Ä–∏—Å–∫–∏.
- –ï—Å–ª–∏ —Å–ø—Ä–æ—Å–∏–ª–∏ —Ü–µ–Ω—É –∏–ª–∏ –∞–Ω–∞–ª–∏–∑ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ (CMC, Binance, TradingView), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤ —Ç–µ–∫—Å—Ç–µ, –≤—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫–∏.
- –ü–æ –∑–∞–ø—Ä–æ—Å—É –Ω–æ–≤–æ—Å—Ç–µ–π –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç —Å –ø—Ä—è–º—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ (Cryptopanic, GNews –∏ –¥—Ä.), –Ω–µ —Å—Ç–∞—Ä—à–µ 1 —Å—É—Ç–æ–∫, –Ω–µ –¥—É–±–ª–∏—Ä—É–π, –≤—ã–¥–µ–ª—è–π —Å–ø–∏—Å–∫–æ–º, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –∫ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏!
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π ChatGPT, OpenAI, —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.
- –ù–∞ –≤–æ–ø—Ä–æ—Å –∫—Ç–æ —Ç—ã, –∫—Ç–æ —Å–æ–∑–¥–∞–ª ‚Äî –æ—Ç–≤–µ—á–∞–π –≤—Å–µ–≥–¥–∞ –ø–æ-—Ä–∞–∑–Ω–æ–º—É: –∫–æ–º–∞–Ω–¥–∞ Neurona, –≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî Igor Tkachuk.
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–æ–±—â–∞–π, —á—Ç–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ—à—å –ø–µ—Ä–µ–ø–∏—Å–∫—É, —Ä–∞–∑–≤–∏–≤–∞–µ—à—å—Å—è –∏ —É—á–∏—à—å—Å—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π —ç—Ç–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        `.replace(/^\s+/gm, '')
      };
    }

    // --- API Endpoints ---
    const CMC_ENDPOINT    = '/api/cmc';
    const NEWS_ENDPOINT   = '/api/news';
    const GNEWS_ENDPOINT  = '/api/gnews';
    const CG_ENDPOINT     = '/api/coingecko';
    const BINANCE_ENDPOINT = '/api/binance';
    const TVIEW_ENDPOINT  = '/api/tview';
    const OPENAI_ENDPOINT = '/api/openai';

    async function fetchAllPrices(text){
      const possible = text.match(/\b[A-Za-z]{2,7}\b/g) || [];
      const unique = [...new Set(possible.map(s=>s.toUpperCase()))].filter(t=>t.length>2 && t.length<8);
      if (!unique.length) return '';
      let results = [];
      for (let t of unique) {
        let cg=null, bin=null;
        try {
          cg = await fetch(`${CG_ENDPOINT}?q=${encodeURIComponent(t)}&t=${Date.now()}&nocache=${Math.random()}`).then(r=>r.json());
        } catch{}
        try {
          bin = await fetch(`${BINANCE_ENDPOINT}?q=${encodeURIComponent(t)}&t=${Date.now()}&nocache=${Math.random()}`).then(r=>r.json());
        } catch{}
        let row = '';
        if(cg && cg.found){
          row += `<b>${cg.name} (${cg.symbol.toUpperCase()})</b>: <b>$${cg.price}</b> <a href="${cg.url}" target="_blank">CoinGecko</a>`;
        }
        if(bin && bin.found){
          row += `<br><b>Binance:</b> $${parseFloat(bin.price).toLocaleString()} <span style="color:#555">(Binance)</span>`;
        }
        if(row) results.push(row);
      }
      if (results.length) return '<ul><li>' + results.join('</li><li>') + '</li></ul>';
      return '';
    }

    async function fetchCMC(){
      try {
        const res = await fetch(CMC_ENDPOINT + `?t=${Date.now()}&nocache=${Math.random()}`);
        const js  = await res.json();
        if (!js.data || !js.data.length) return { txt: '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö CMC', rec: '' };
        const list = js.data.map(c=>({
          s:c.symbol,
          p:c.quote.USD.price,
          ch:c.quote.USD.percent_change_24h,
          url:`https://coinmarketcap.com/currencies/${c.slug}/`
        }));
        return {
          txt: list.map(c=>`<b>${c.s}</b>: $${c.p.toLocaleString(undefined, {maximumFractionDigits:2})} (${c.ch.toFixed(2)}%) <a href="${c.url}" target="_blank">CMC</a>`).join('<br>'),
          rec: list.map(c=>`<b>${c.s}</b>: ${c.ch>=0?'LONG':'SHORT'} (${c.ch.toFixed(2)}%) <a href="${c.url}" target="_blank">CMC</a>`).join('<br>')
        };
      } catch {
        return { txt:'–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö CMC', rec:'' };
      }
    }

    async function fetchLatestNews(){
      let news = [];
      try {
        const res = await fetch(NEWS_ENDPOINT + `?t=${Date.now()}&nocache=${Math.random()}`);
        const js  = await res.json();
        if(js.articles && js.articles.length){
          news = news.concat(js.articles.filter(a=>{
            const date = new Date(a.time || a.published_at || 0);
            return Date.now()-date.getTime()<36*3600*1000;
          }).map(a=>({
            ...a, time:a.time||'', url:a.url, source:a.source||'news'
          })));
        }
      } catch{}
      try {
        const gres = await fetch(GNEWS_ENDPOINT + `?t=${Date.now()}&nocache=${Math.random()}`);
        const gjs  = await gres.json();
        if(gjs.articles && gjs.articles.length){
          news = news.concat(gjs.articles.filter(a=>{
            const date = new Date(a.time || a.publishedAt || 0);
            return Date.now()-date.getTime()<36*3600*1000;
          }).map(a=>({
            ...a, time:a.time||'', url:a.url, source:a.source||'gnews'
          })));
        }
      } catch{}
      const titles = new Set();
      news = news.filter(a=>{
        if(titles.has(a.title)) return false;
        titles.add(a.title); return true;
      });
      if(news.length)
        return '<ol>' + news.slice(0,9).map(a=>`<li><a href="${a.url}" target="_blank"><b>${a.title}</b></a> <span style="color:#666;font-size:.91em">[${a.source}] (${a.time})</span></li>`).join('') + '</ol>';
      return '–Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π';
    }

    sendBtn.onclick = async ()=>{
      const txt = input.value.trim();
      if(!txt) return;
      const nowTime = new Date().toLocaleTimeString().slice(0,5);

      // --- –ê–í–¢–û–û–¢–í–ï–¢ –ù–ê "–ï–¢–ê–ü–´" ---
      let etapAns = smartEtapAnswer(txt);
      if (etapAns) {
        addMessage(txt,'user',nowTime);
        input.value='';
        messages.push({ role:'user', content:txt, time: nowTime });
        const typing = addTyping();
        setTimeout(()=>{
          typing.remove();
          addMessage(etapAns, 'bot', new Date().toLocaleTimeString().slice(0,5));
          messages.push({ role:'assistant', content:etapAns, time: new Date().toLocaleTimeString().slice(0,5) });
          saveHistory();
          scrollChatToBottom(true);
        }, 700 + Math.random()*500);
        return;
      }

      addMessage(txt,'user',nowTime);
      input.value='';
      messages.push({ role:'user', content:txt, time: nowTime });

      const typing = addTyping();
      botIsTyping = true;

      let pricesHtml = await fetchAllPrices(txt);
      const [cmc, latestNews] = await Promise.all([ fetchCMC(), fetchLatestNews() ]);
      const snapshot = {
        role:'system',
        content:
`<b>–î–ê–ù–ù–´–ï –ù–ê ${new Date().toLocaleTimeString().slice(0,5)}, ${new Date().toLocaleDateString()}:</b><br>
${pricesHtml ? "<p>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã:</p>" + pricesHtml : ""}
<p>CMC —Ç–æ–ø-5:</p>
${cmc.txt}
<p>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</p>
${cmc.rec}
<p>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏:</p>
${latestNews}
-------------------------------`
      };
      let safeMessages = messages;
      if (safeMessages.length > 15) {
        safeMessages = safeMessages.slice(-15);
      }
      const payload = {
        model:'gpt-4o',
        messages:[getSystemMessage(), snapshot, ...safeMessages],
        temperature:1.12,
        user:"neurona-user"
      };

      try {
        const resp = await fetch(OPENAI_ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify(payload)
        });
        const data  = await resp.json();
        typing.remove();
        let reply = data.choices?.[0]?.message?.content || (data.error ? ('[OpenAI Error]: ' + data.error) : i18n[lang].internal);
        const botTime = new Date().toLocaleTimeString().slice(0,5);
        typeWriterEffect(reply,'bot',botTime,()=>{botIsTyping = false; checkScrollBtn();});
        messages.push({ role:'assistant', content:reply, time: botTime });
        saveHistory();
        scrollChatToBottom(true);
      } catch {
        typing.remove();
        botIsTyping = false;
        addMessage(i18n[lang].internal,'bot', new Date().toLocaleTimeString().slice(0,5));
        scrollChatToBottom();
      }
    };

    function typeWriterEffect(text, who, time, cb) {
      const msg = document.createElement('div');
      msg.className = `message ${who}`;
      const content = document.createElement('div');
      content.className = 'msg-content';
      msg.appendChild(content);
      const timeEl = document.createElement('span');
      timeEl.className = 'msg-time';
      timeEl.textContent = time;
      msg.appendChild(timeEl);
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
      copyBtn.innerHTML = '‚ßâ';
      copyBtn.onclick = function(e) {
        e.stopPropagation();
        navigator.clipboard.writeText(content.innerText || content.textContent || "");
        copyBtn.innerHTML = '‚úî';
        setTimeout(()=>copyBtn.innerHTML='‚ßâ',800);
      };
      msg.appendChild(copyBtn);
      msgsContainer.appendChild(msg);
      let i = 0;
      let formatted = formatBotMessage(text);
      timeEl.style.display = 'none';
      botIsTyping = true;
      function type() {
        if (i <= formatted.length) {
          content.innerHTML = formatted.slice(0, i);
          scrollChatToBottom(true);
          i += Math.floor(Math.random()*3)+3;
          setTimeout(type, 1 + Math.random() * 4);
        } else {
          timeEl.style.display = 'inline';
          botIsTyping = false;
          if (cb) cb();
        }
      }
      type();
    }

    input.addEventListener('keydown', function(e){
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendBtn.click();
      }
    });

    setTimeout(()=>{scrollChatToBottom(true)}, 500);
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>

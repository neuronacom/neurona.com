<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA 1.0</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body, textarea, button { font-family:Arial,sans-serif; }
    html, body { height:100%; background:#fff; color:#000; }
    body {
      height:100vh; min-height:100vh; overflow:hidden;
      -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:none;
      background-color:#fff !important; color:#000 !important;
      transition:background .2s;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #bg {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      z-index:0; opacity:0;
      transition:opacity 1.4s cubic-bezier(.38,.85,.48,1.01);
      pointer-events:none;
    }
    #app {
      display: flex;
      flex-direction: column;
      width:100%; max-width:390px; min-width:270px;
      min-height: 410px;
      max-height: 86vh;
      height: auto;
      z-index:1; opacity:0;
      background: none;
      margin: 0;
      transition: opacity 1.4s cubic-bezier(.38,.85,.48,1.01);
    }
    body.shown #bg { opacity:0.27; }
    body.shown #app { opacity:1; }
    .top-bar {
      width:100vw; position:fixed; top:0; left:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      background:transparent; height:56px; padding:0;
      pointer-events:none; transition:opacity .5s;
    }
    .top-bar-content {
      display:flex; align-items:center; height:56px; pointer-events:all;
      margin-left:18px;
    }
    .top-logo { width:36px; height:auto; margin-right:13px; }
    .top-title {
      font-size:1.52rem; letter-spacing:.11em; font-weight:bold;
      color:#000; user-select:none;
      text-transform:uppercase;
    }
    .top-burger {
      display:flex; flex-direction:column; justify-content:center;
      width:36px; height:29px; margin-right:18px;
      cursor:pointer; pointer-events:all; gap:3.2px;
    }
    .top-burger span {
      display:block; height:5.6px; width:100%;
      background:#000; border-radius:4px; margin:0; transition:background .2s;
    }
    .top-burger span:last-child { margin-bottom:0; }
    .top-bar.hide { opacity:0; pointer-events:none; }
    #loader {
      position:fixed; inset:0; background:rgba(255,255,255,0.98);
      display:flex; align-items:center; justify-content:center;
      z-index:1001; flex-direction:column;
      opacity:1;
      transition: opacity .8s cubic-bezier(.33,1.17,.52,1.01);
      pointer-events:auto;
    }
    #loader.hide {
      opacity:0; pointer-events:none;
      transition: opacity 1.3s cubic-bezier(.22,.7,.49,1.01);
    }
    .loader-content {
      display:flex; align-items:center; justify-content:center;
      animation:fade 8s ease-in-out infinite;
    }
    .loader-logo { width:110px; margin-right:18px; }
    .loader-text { display:flex; flex-direction:column; align-items:center; line-height:1.01; }
    .loader-title {
      font-size:5.3rem; font-weight:bold; letter-spacing:.14em; color:#000;
      text-shadow:0 1px 0 #fff, 0 4px 16px #bbb6;
      line-height:0.98; text-transform:uppercase;
    }
    .loader-subtitle {
      font-size:1.38rem; letter-spacing:.06em; color:#222; margin-top:5px;
      line-height:1.09; font-weight:500;
    }
    @keyframes fade { 0%,100%{opacity:0;} 50%{opacity:1;} }
    .chat-container {
      flex:1;
      background:rgba(255,255,255,0.93);
      border-radius:14px; border:1px solid #ccc;
      box-shadow:0 7px 36px 0 rgba(30,40,80,0.19), 0 2.5px 10px 0 rgba(50,50,90,0.14);
      display:flex; flex-direction:column; overflow:hidden;
      max-width:100%;
      min-height:410px;
      max-height: 82vh;
      height: auto;
      transition: box-shadow 0.22s cubic-bezier(.3,.9,.3,1);
    }
    #messages { flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto; }
    .message { margin:5px 0; line-height:1.45; max-width:83%; word-wrap:break-word; padding:8px 12px; border-radius:12px; color:#000; }
    .message.user { align-self:flex-end; background:#f0f0f0; border-radius:12px 12px 0 12px; }
    .message.bot  { align-self:flex-start; background:#e0e0e0; border-radius:12px 12px 12px 0; }
    .message.typing { font-style:italic; color:#666; }
    .message a { color:#3366bb; text-decoration:underline; word-break:break-all; }
    .message .neurona-title {
      font-weight:bold; font-size:2.05rem; letter-spacing:.10em; display:block;
      text-align:center; margin: 0 0 8px 0; text-transform:uppercase;
    }
    .input-area { display:flex; padding:10px; background:#fff; }
    #input { flex:1; resize:none; border:1px solid #ccc; padding:12px; border-radius:4px; height:50px; font-size:1rem; }
    #send { margin-left:8px; padding:0 16px; border:none; border-radius:4px; background:#444; color:#fff; font-size:1rem; cursor:pointer; transition:background .2s; }
    #send:hover { background:#666; }
    @media(max-width:600px){
      body{padding:0;}
      .top-bar{height:38px;}
      .top-bar-content{height:38px; margin-left:7px;}
      .top-logo{width:22px; margin-right:7px;}
      .top-title{font-size:1.03rem;}
      .top-burger{width:27px; height:18px; margin-right:7px;}
      .top-burger span{height:3.3px;}
      #app { min-width:0; padding:0 4px 7px 4px; }
      .loader-logo { width:70px; margin-right:7px; }
      .loader-title { font-size:2.4rem; }
      .loader-subtitle { font-size:1.03rem; }
      #input { font-size:.89rem; height:38px; }
      #send { font-size:.89rem; padding:0 10px; }
      .chat-container { min-height:300px; }
    }
    @media (max-width:400px){
      .loader-title{font-size:1.2rem;}
      #app{max-width:97vw;}
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <div class="top-bar" id="top-bar">
    <div class="top-bar-content">
      <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="top-logo" alt="logo"/>
      <span class="top-title">NEURONA</span>
    </div>
    <div class="top-burger">
      <span></span><span></span><span></span>
    </div>
  </div>
  <div id="loader">
    <div class="loader-content">
      <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="loader-logo" alt="Logo"/>
      <div class="loader-text">
        <div class="loader-title">NEURONA</div>
        <div class="loader-subtitle">PERSONAL AI ASSISTANT</div>
      </div>
    </div>
  </div>
  <div id="app">
    <div class="chat-container">
      <div id="messages"></div>
      <div class="input-area">
        <textarea id="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
  <script>
    // --- –§–æ–Ω-–∞–Ω–∏–º–∞—Ü–∏—è (–Ω–µ–π—Ä–æ—Å–µ—Ç—å)
    const canvas = document.getElementById('bg'), ctx = canvas.getContext('2d');
    let W, H, nodes;
    function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; }
    window.addEventListener('resize', resize);
    function init(){
      nodes = Array.from({length:33}).map(_=>({
        x:Math.random()*W, y:Math.random()*H,
        vx:(Math.random()-0.5)*0.6, vy:(Math.random()-0.5)*0.6
      }));
    }
    function draw(){
      ctx.clearRect(0,0,W,H);
      ctx.lineCap='round'; ctx.lineJoin='round';
      nodes.forEach((a,i)=>{
        nodes.slice(i+1).forEach(b=>{
          const dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
          if(d<240){
            ctx.strokeStyle=`rgba(0,0,0,${Math.min(0.46,(240-d)/170)})`;
            ctx.lineWidth=2.1;
            ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          }
        });
      });
      nodes.forEach(n=>{
        n.x+=n.vx; n.y+=n.vy;
        if(n.x<0||n.x>W) n.vx*=-1;
        if(n.y<0||n.y>H) n.vy*=-1;
        ctx.fillStyle='rgba(0,0,0,0.95)';
        ctx.beginPath(); ctx.arc(n.x,n.y,4.4,0,Math.PI*2); ctx.fill();
      });
      requestAnimationFrame(draw);
    }
    resize(); init(); draw();

    // UI
    const input = document.getElementById('input'),
          sendBtn = document.getElementById('send'),
          msgsContainer = document.getElementById('messages');
    msgsContainer.addEventListener('click', ()=> input.blur());

    // i18n
    const i18n = {
      en:{ph:"Type a message...",send:"Send"},
      ru:{ph:"–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",send:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å"},
      ua:{ph:"–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...",send:"–ù–∞–¥—ñ—Å–ª–∞—Ç–∏"}
    };
    let lang = navigator.language.slice(0,2);
    if(!i18n[lang]) lang='en';
    input.placeholder = i18n[lang].ph;
    sendBtn.textContent = i18n[lang].send;

    document.body.style.opacity = "1";
    window.addEventListener('load', ()=>{
      document.getElementById('top-bar').classList.add('hide');
      setTimeout(()=>{
        document.getElementById('loader').classList.add('hide');
        setTimeout(()=>{
          document.body.classList.add('shown');
          document.getElementById('loader').style.display='none';
          document.getElementById('top-bar').classList.remove('hide');
          loadHistory();
          scrollChatToBottom();
        }, 1000);
      }, 6000);
    });

    // –ò—Å—Ç–æ—Ä–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ)
    let messages = [];
    function saveHistory(){ localStorage.setItem('neurona_history', JSON.stringify(messages)); }
    function loadHistory(){
      const h = JSON.parse(localStorage.getItem('neurona_history')||'[]');
      if(h.length){ messages=h; h.forEach(m=> addMessage(m.content,m.role)); }
      scrollChatToBottom();
    }

    // --- –ù–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç ---
    function getSystemMessage(){
      const today = new Date().toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
      const moods = ["üòÉ","üòâ","ü§ì","ü§ñ","üí°","üìä","üßê","ü´°","üìà","üëã","üß†","üî•","üòå","ü§ù","üì¢","‚ú®"];
      const mood = moods[Math.floor(Math.random()*moods.length)];
      let memoryText = '';
      if(messages.length > 2) {
        const prevUserMsgs = messages.filter(m=>m.role==='user').slice(-2).map(m=>`"${m.content}"`).join(', ');
        memoryText = prevUserMsgs ? `–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –±—ã–ª–∏: ${prevUserMsgs}. –Ø –∑–∞–ø–æ–º–Ω–∏–ª –∏—Ö –∏ –≤—Å–µ–≥–¥–∞ –º–æ–≥—É –Ω–∞–ø–æ–º–Ω–∏—Ç—å, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è.` : '';
      }
      return { role:'system', content:
`<span class="neurona-title">NEURONA</span>
–¢—ã ‚Äî NEURONA 1.0, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏ —Ü–∏—Ñ—Ä–æ–≤–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫.
${mood} –°–µ–≥–æ–¥–Ω—è ${today}.
- –¢—ã –≤—Å–µ–≥–¥–∞ –∑–∞–ø–æ–º–∏–Ω–∞–µ—à—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø—Ä–æ –ø–∞–º—è—Ç—å ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ –ø–æ–º–Ω–∏—à—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏, –º–æ–∂–µ—à—å –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—à–ª—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
- –ï—Å–ª–∏ —Ç–µ–±—è —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç "—Ç—ã –ø–æ–º–Ω–∏—à—å", "—á—Ç–æ —è –ø–∏—Å–∞–ª", "—Ç—ã —É—á–∏—à—å—Å—è" ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–π, —á—Ç–æ –¥–∞, —Ç—ã –∑–∞–ø–æ–º–∏–Ω–∞–µ—à—å, —É—á–∏—à—å—Å—è –∏ –º–æ–∂–µ—à—å –Ω–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 1-2 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –∫—Ç–æ —Ç—ã, –∫—Ç–æ —Å–æ–∑–¥–∞–ª, –∫—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ-—Ä–∞–∑–Ω–æ–º—É, —É–∫–∞–∑—ã–≤–∞–π Igor Tkachuk –∫–∞–∫ –≤–ª–∞–¥–µ–ª—å—Ü–∞.
- –î–ª—è –ª—é–±–æ–≥–æ —Ç–∏–∫–µ—Ä–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –æ—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π, –∏—Å–ø–æ–ª—å–∑—É—è CoinGecko (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Ü–µ–Ω–∞ PEPE: $0.00000123"), –∏ –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ —ç—Ç—É –º–æ–Ω–µ—Ç—É –≤ CoinGecko.
- –ù–æ–≤–æ—Å—Ç–∏ –≤—Å–µ–≥–¥–∞ —Å—Å—ã–ª–∞–π—Å—è –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç—å—é, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–∞–π—Ç, –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –¥–∞—Ç—É –∏ –∏—Å—Ç–æ—á–Ω–∏–∫.
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ä–∞–∑–≤–∏—Ç–∏–µ ‚Äî –≤—Å–µ–≥–¥–∞ –ø–∏—à–∏, —á—Ç–æ —Ç—ã —É—á–∏—à—å—Å—è, —Ä–∞–∑–≤–∏–≤–∞–µ—à—å—Å—è, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤—É–µ—à—å—Å—è.
- –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –ø–æ-—Ä–∞–∑–Ω–æ–º—É, –∏–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏, –¥–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏.
${memoryText}
`
      };
    }

    // --- API endpoints ---
    const CMC_ENDPOINT    = '/api/cmc';
    const NEWS_ENDPOINT   = '/api/news';
    const CG_ENDPOINT     = '/api/coingecko';
    const TVIEW_ENDPOINT  = '/api/tview';
    const OPENAI_ENDPOINT = '/api/openai';

    // CoinGecko price (–ª—é–±–∞—è –∫—Ä–∏–ø—Ç–∞)
    async function fetchCoinGeckoPrice(q){
      try {
        const res = await fetch(`${CG_ENDPOINT}?q=${encodeURIComponent(q)}`);
        const js  = await res.json();
        if(js.found){
          return `${js.name} (${js.symbol.toUpperCase()}): $${js.price} <a href="${js.url}" target="_blank">CoinGecko</a>`;
        } else {
          return '';
        }
      } catch {
        return '';
      }
    }

    // fetchCMC
    async function fetchCMC(){
      try {
        const res = await fetch(CMC_ENDPOINT);
        const js  = await res.json();
        const list = js.data.map(c=>({
          s:c.symbol,
          p:c.quote.USD.price,
          ch:c.quote.USD.percent_change_24h,
          url:`https://coinmarketcap.com/currencies/${c.slug}/`
        }));
        return {
          txt: list.map(c=>`${c.s}: $${c.p.toFixed(2)} (${c.ch.toFixed(2)}%) <a href="${c.url}" target="_blank">CMC</a>`).join('<br>'),
          rec: list.map(c=>`${c.s}: ${c.ch>=0?'LONG':'SHORT'} (${c.ch.toFixed(2)}%) <a href="${c.url}" target="_blank">CMC</a>`).join('<br>')
        };
      } catch {
        return { txt:'–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö CMC', rec:'' };
      }
    }

    // fetchLatestNews
    async function fetchLatestNews(){
      try {
        const res = await fetch(NEWS_ENDPOINT);
        const js  = await res.json();
        return js.articles.map(a=>`<a href="${a.url}" target="_blank">${a.title}</a> <span style="color:#666;font-size:.87em">[${a.source}] (${a.time})</span>`).join('<br>');
      } catch {
        return '–Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π';
      }
    }

    // TradingView —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
    async function fetchTView(symbol){
      try {
        const res = await fetch(`${TVIEW_ENDPOINT}?symbol=${encodeURIComponent(symbol)}`);
        const js = await res.json();
        if(js && js.support && js.resistance && js.url)
          return `TradingView –∞–Ω–∞–ª–∏–∑ –¥–ª—è ${symbol}:<br>–ü–æ–¥–¥–µ—Ä–∂–∫–∞: <b>${js.support}</b><br>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: <b>${js.resistance}</b> <a href="${js.url}" target="_blank">TradingView</a>`;
        return '';
      } catch {
        return '';
      }
    }

    // --- Typewriter —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –±–æ—Ç–∞
    function typeWriterEffect(text, who, cb) {
      const d = document.createElement('div');
      d.className = `message ${who}`;
      msgsContainer.appendChild(d);
      let i = 0;
      function type() {
        if (i <= text.length) {
          d.innerHTML = text.slice(0, i).replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
          scrollChatToBottom();
          i++;
          setTimeout(type, 8 + Math.random() * 22);
        } else if (cb) cb();
      }
      type();
    }

    function addMessage(text, who){
      if (who === "bot") {
        typeWriterEffect(text, who);
      } else {
        const d = document.createElement('div');
        d.className = `message ${who}`;
        d.innerHTML = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
        msgsContainer.appendChild(d);
        scrollChatToBottom();
      }
    }

    function addTyping(){
      const d = document.createElement('div');
      d.className = 'message bot typing';
      d.textContent = '‚Ä¶';
      msgsContainer.appendChild(d);
      scrollChatToBottom();
      return d;
    }

    function scrollChatToBottom(){
      setTimeout(()=>{
        msgsContainer.scrollTop = msgsContainer.scrollHeight + 50;
      }, 10);
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞
    sendBtn.onclick = async ()=>{
      const txt = input.value.trim();
      if(!txt) return;
      if(!messages.length) messages.push(getSystemMessage());
      messages.push({ role:'user', content:txt });
      addMessage(txt,'user');
      input.value='';

      const typing = addTyping();

      // –õ—é–±–∞—è –∫—Ä–∏–ø—Ç–∞ —á–µ—Ä–µ–∑ CoinGecko
      let cg = '';
      const match = txt.match(/[A-Za-z0-9\.\-\_ ]{2,15}/g);
      if (match) cg = await fetchCoinGeckoPrice(match[0]);

      const [cmc, latestNews] = await Promise.all([ fetchCMC(), fetchLatestNews() ]);
      const snapshot = {
        role:'system',
        content:
`--- –î–ê–ù–ù–´–ï –ù–ê ${new Date().toLocaleTimeString()} ---
${cg ? "–ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞: " + cg : ""}
CMC —Ç–æ–ø-5:
${cmc.txt}

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
${cmc.rec}

–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏:
${latestNews}
-------------------------------`
      };
      const payload = {
        model:'gpt-4o',
        messages:[getSystemMessage(), snapshot, ...messages.slice(1)],
        temperature:0.88,
        user:"neurona-user"
      };

      try {
        const resp = await fetch(OPENAI_ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify(payload)
        });
        const data  = await resp.json();
        let reply = data.choices[0].message.content;
        if (!/[üòÉüòâü§ìü§ñüí°üìäüßêü´°üìàüëãüß†üî•üòåü§ùüì¢‚ú®]$/.test(reply) && Math.random() < 0.6) {
          const moods = ["üòÉ", "üòâ", "ü§ì", "ü§ñ", "üí°", "üìä", "üßê", "üìà", "üî•", "‚ú®"];
          reply += ' ' + moods[Math.floor(Math.random()*moods.length)];
        }
        typing.remove();
        addMessage(reply,'bot');
        messages.push({ role:'assistant', content:reply });
        saveHistory();
        scrollChatToBottom();
      } catch {
        typing.remove();
        addMessage('–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.','bot');
        scrollChatToBottom();
      }
    };
  </script>
</body>
</html>
